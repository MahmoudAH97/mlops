name: MLOps End-to-End Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # ACR
  ACR_LOGIN: ${{ secrets.ACR_LOGIN }}
  ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
  ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}

  IMAGE_NAME: animal-inference

jobs:

  train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install training dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pillow tensorflow scikit-learn

      # ---------------------------
      # 1. Data Preparation
      # ---------------------------
      - name: Run data preparation
        run: |
          python components/dataprep/dataprep.py \
            --data_folder data/raw \
            --output_folder data/processed

      # ---------------------------
      # 2. Train/Test Split
      # ---------------------------
      - name: Run data split
        run: |
          python components/split/split.py \
            --input_folder data/processed \
            --train_folder data/split/train \
            --test_folder data/split/test \
            --ratio 0.8

      # ---------------------------
      # 3. Training
      # ---------------------------
      - name: Run model training
        run: |
          python components/training/training.py \
            --train_folder data/split/train \
            --test_folder data/split/test \
            --epochs 3 \
            --model_output model_output

      - name: Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: model_output/model.h5

  build:
    runs-on: ubuntu-latest
    needs: train

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: inference

      - name: Login to ACR
        run: |
          echo $ACR_PASSWORD | docker login $ACR_LOGIN -u $ACR_USERNAME --password-stdin

      - name: Build Docker image
        run: |
          docker build -t $ACR_LOGIN/$IMAGE_NAME:latest inference

      - name: Push Docker image
        run: |
          docker push $ACR_LOGIN/$IMAGE_NAME:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y kubectl

      - name: Write kubeconfig
        run: |
          echo "${{ secrets.AKS_KUBECONFIG }}" > kubeconfig
          chmod 600 kubeconfig

      - name: Update deployment image
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|${{ env.ACR_LOGIN }}/${{ env.IMAGE_NAME }}:latest|g" k8s/deployment.yaml

      - name: Apply Kubernetes manifests
        run: |
          KUBECONFIG=kubeconfig kubectl apply -f k8s/deployment.yaml
          KUBECONFIG=kubeconfig kubectl apply -f k8s/service.yaml

      - name: Verify Deployment
        run: |
          KUBECONFIG=kubeconfig kubectl get pods -o wide
          KUBECONFIG=kubeconfig kubectl get svc -o wide
