name: MLOps End-to-End Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  ACR_LOGIN: ${{ secrets.ACR_LOGIN }}
  ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
  ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
  AZURE_BLOB_CONNECTION_STRING: ${{ secrets.AZURE_BLOB_CONNECTION_STRING }}
  IMAGE_NAME: animal-inference

jobs:

  train:
    runs-on: ubuntu-latest

    steps:
      - name: DEBUG | Print runner info
        run: |
          echo "Runner OS:"
          uname -a
          echo "Python version:"
          python3 --version

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Create dataset folders
        run: |
          mkdir -p data/raw
          mkdir -p data/processed
          mkdir -p data/split/train
          mkdir -p data/split/test

      - name: Download dataset from Azure Blob
        run: |
          echo "Downloading dataset from Azure Blob..."
          az storage blob download-batch \
            --connection-string "$AZURE_BLOB_CONNECTION_STRING" \
            -s "azureml-blobstore-30bd3442-a52f-4ca1-b6b8-e34d75c41103/UI/2025-11-27_111021_UTC/animals" \
            -d "data/raw"

      - name: DEBUG | Show downloaded dataset
        run: |
          echo "=== RAW DATA FOLDERS ==="
          ls -R data/raw

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pillow tensorflow scikit-learn rich

      - name: Run ML pipeline (dataprep → split → training)
        run: |
          echo "Running dataprep..."
          python components/dataprep/dataprep.py \
            --data_folder data/raw \
            --output_folder data/processed

          echo "Running split..."
          python components/split/split.py \
            --input_folder data/processed \
            --train_folder data/split/train \
            --test_folder data/split/test \
            --ratio 0.8

          echo "DEBUG | split/train:"
          ls -R data/split/train

          echo "Starting training..."
          python components/training/training.py \
            --train_folder data/split/train \
            --test_folder data/split/test \
            --epochs 3 \
            --model_output model_output

      - name: Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: model_output/model.h5

  build:
    runs-on: ubuntu-latest
    needs: train

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: inference

      - name: Login to ACR
        run: |
          echo $ACR_PASSWORD | docker login $ACR_LOGIN -u $ACR_USERNAME --password-stdin

      - name: Build Docker image
        run: |
          docker build -t $ACR_LOGIN/$IMAGE_NAME:latest inference

      - name: Push Docker image
        run: |
          docker push $ACR_LOGIN/$IMAGE_NAME:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y kubectl

      - name: Write kubeconfig
        run: |
          echo "${{ secrets.AKS_KUBECONFIG }}" > kubeconfig
          chmod 600 kubeconfig

      - name: Update deployment image
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|${{ env.ACR_LOGIN }}/${{ env.IMAGE_NAME }}:latest|g" k8s/deployment.yaml

      - name: Deploy to AKS
        run: |
          KUBECONFIG=kubeconfig kubectl apply -f k8s/deployment.yaml
          KUBECONFIG=kubeconfig kubectl apply -f k8s/service.yaml

      - name: Verify Deployment
        run: |
          KUBECONFIG=kubeconfig kubectl get pods -o wide
          KUBECONFIG=kubeconfig kubectl get svc -o wide
