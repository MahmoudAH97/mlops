name: MLOps End-to-End Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  # ACR
  ACR_LOGIN: ${{ secrets.ACR_LOGIN }}
  ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
  ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}

  # Storage secret (connection string)
  AZURE_BLOB_CONNECTION_STRING: ${{ secrets.AZURE_BLOB_CONNECTION_STRING }}

  # Image name
  IMAGE_NAME: animal-inference

jobs:

  # ======================================================
  # 1. TRAIN MODEL LOCALLY IN GITHUB ACTIONS
  # ======================================================
  train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------
      # Install Azure CLI (correct action)
      # ----------------------------------------
      - name: Install Azure CLI
        uses: actions/azure-cli@v2

      # ----------------------------------------
      # Download dataset from Azure Blob
      # ----------------------------------------
      - name: Download dataset from Azure Blob
        env:
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_BLOB_CONNECTION_STRING }}
        run: |
          mkdir -p data/raw
          echo "Downloading dataset from Azure Blob…"

          az storage blob download-batch \
            --destination data/raw \
            --source "azureml-blobstore-30bd3442-a52f-4ca1-b6b8-e34d75c41103/UI/2025-11-27_111021_UTC/animals" \
            --connection-string "$AZURE_STORAGE_CONNECTION_STRING"

          echo "Download complete. Files:"
          ls -R data/raw

      # ----------------------------------------
      # Python setup + dependencies
      # ----------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install training dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pillow tensorflow scikit-learn

      # ----------------------------------------
      # Run ML pipeline
      # ----------------------------------------
      - name: Run ML pipeline (dataprep → split → training)
        run: |
          python components/dataprep/dataprep.py \
            --data_folder data/raw \
            --output_folder data/processed

          python components/split/split.py \
            --input_folder data/processed \
            --train_folder data/split/train \
            --test_folder data/split/test \
            --ratio 0.8

          python components/training/training.py \
            --train_folder data/split/train \
            --test_folder data/split/test \
            --epochs 3 \
            --model_output model_output

      # ----------------------------------------
      # Upload trained model
      # ----------------------------------------
      - name: Upload trained model for next job
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: model_output/model.h5

  # ======================================================
  # 2. BUILD & PUSH DOCKER IMAGE TO ACR
  # ======================================================
  build:
    runs-on: ubuntu-latest
    needs: train

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: inference

      - name: Login to ACR
        run: |
          echo $ACR_PASSWORD | docker login $ACR_LOGIN -u $ACR_USERNAME --password-stdin

      - name: Build Docker image
        run: |
          docker build -t $ACR_LOGIN/$IMAGE_NAME:latest inference

      - name: Push Docker image
        run: |
          docker push $ACR_LOGIN/$IMAGE_NAME:latest

  # ======================================================
  # 3. DEPLOY TO AKS USING KUBECONFIG
  # ======================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y kubectl

      - name: Write kubeconfig
        run: |
          echo "${{ secrets.AKS_KUBECONFIG }}" > kubeconfig
          chmod 600 kubeconfig

      - name: Update deployment image
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|${{ env.ACR_LOGIN }}/${{ env.IMAGE_NAME }}:latest|g" k8s/deployment.yaml

      - name: Apply Kubernetes manifests
        run: |
          KUBECONFIG=kubeconfig kubectl apply -f k8s/deployment.yaml
          KUBECONFIG=kubeconfig kubectl apply -f k8s/service.yaml

      - name: Verify Deployment
        run: |
          KUBECONFIG=kubeconfig kubectl get pods -o wide
          KUBECONFIG=kubeconfig kubectl get svc -o wide
