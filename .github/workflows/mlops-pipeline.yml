name: MLOps End-to-End Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  # ACR
  ACR_LOGIN: ${{ secrets.ACR_LOGIN }}
  ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
  ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}

  # Azure Storage (dataset)
  AZURE_BLOB_CONNECTION_STRING: ${{ secrets.AZURE_BLOB_CONNECTION_STRING }}

  # Image name
  IMAGE_NAME: animal-inference

jobs:

  # ======================================================
  # 1. TRAINING JOB
  # ======================================================
  train:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # Checkout
      # ---------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------
      # Python Setup
      # ---------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          echo "=== Installing training dependencies ==="
          python -m pip install --upgrade pip
          pip install pillow tensorflow scikit-learn

      # ---------------------------
      # Download dataset from Azure Blob
      # ---------------------------
      - name: Download dataset from Azure Blob
        uses: azure/cli@v2
        with:
          inlineScript: |
            echo "=== Azure CLI version ==="
            az --version

            echo "=== Preparing raw data folder ==="
            mkdir -p data/raw

            echo "=== Downloading dataset ==="
            az storage blob download-batch \
              --destination data/raw \
              --source "azureml-blobstore-30bd3442-a52f-4ca1-b6b8-e34d75c41103/UI/2025-11-27_111021_UTC/animals" \
              --connection-string "${AZURE_BLOB_CONNECTION_STRING}" \
              --pattern "*.jpg"

            echo "=== Count downloaded files ==="
            find data/raw -type f | wc -l

            echo "=== List raw files ==="
            ls -R data/raw || true

            if [ "$(find data/raw -type f | wc -l)" -eq 0 ]; then
              echo "ERROR: No images downloaded from Azure Blob!"
              exit 1
            fi

      # ---------------------------
      # Run ML pipeline (DataPrep → Split → Train)
      # ---------------------------
      - name: Run ML pipeline
        run: |
          echo "=== Running dataprep ==="
          python components/dataprep/dataprep.py \
            --data_folder data/raw \
            --output_folder data/processed

          echo "=== Running split ==="
          python components/split/split.py \
            --input_folder data/processed \
            --train_folder data/split/train \
            --test_folder data/split/test \
            --ratio 0.8

          echo "=== Running training ==="
          python components/training/training.py \
            --train_folder data/split/train \
            --test_folder data/split/test \
            --epochs 3 \
            --model_output model_output

          echo "=== Training complete ==="
          ls -R model_output

      # ---------------------------
      # Upload trained model as artifact
      # ---------------------------
      - name: Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: model_output/model.h5


  # ======================================================
  # 2. BUILD + PUSH DOCKER IMAGE
  # ======================================================
  build:
    runs-on: ubuntu-latest
    needs: train

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download trained model artifact
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: inference

      - name: Login to ACR
        run: |
          echo "=== Logging into ACR ==="
          echo $ACR_PASSWORD | docker login $ACR_LOGIN -u $ACR_USERNAME --password-stdin

      - name: Build Docker image
        run: |
          echo "=== Building Docker image ==="
          docker build -t $ACR_LOGIN/$IMAGE_NAME:latest inference

      - name: Push Docker image
        run: |
          echo "=== Pushing Docker image ==="
          docker push $ACR_LOGIN/$IMAGE_NAME:latest


  # ======================================================
  # 3. DEPLOY TO AKS USING KUBECONFIG
  # ======================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          echo "=== Installing kubectl ==="
          sudo apt-get update -y
          sudo apt-get install -y kubectl

      - name: Write kubeconfig
        run: |
          echo "=== Writing kubeconfig ==="
          echo "${{ secrets.AKS_KUBECONFIG }}" > kubeconfig
          chmod 600 kubeconfig

      - name: Patch deployment YAML with image
        run: |
          echo "=== Patching deployment.yaml ==="
          sed -i "s|IMAGE_PLACEHOLDER|${ACR_LOGIN}/${IMAGE_NAME}:latest|g" k8s/deployment.yaml

      - name: Apply Kubernetes manifests
        run: |
          echo "=== Applying manifests ==="
          KUBECONFIG=kubeconfig kubectl apply -f k8s/deployment.yaml
          KUBECONFIG=kubeconfig kubectl apply -f k8s/service.yaml

      - name: Verify resources
        run: |
          echo "=== Getting pods ==="
          KUBECONFIG=kubeconfig kubectl get pods -o wide
          echo "=== Getting services ==="
          KUBECONFIG=kubeconfig kubectl get svc -o wide
